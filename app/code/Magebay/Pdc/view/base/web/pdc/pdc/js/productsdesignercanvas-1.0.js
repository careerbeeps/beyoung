!function(e,t){var a=function(){return new a.init},i={base_url:t("#base_url").val(),media_url:t("#pdp_media_url").val(),save_thumbnail_url:t("#base_url").val()+"pdc/save/saveBase64Image/",save_json_url:t("#base_url").val()+"pdc/save/savejsonfile/",save_admin_template:t("#base_url").val()+"pdc/save/saveAdminTemplate/",image_options:{format:"jpeg",quality:t("#image_quality").val()||.7},show_log:!0,default_thumbnail:t("#pdp_media_url").val()+"pdp/images/default_thumbnail.jpg",rerenderClass:"rerender",preview_thumbnail:"jpg",productConfig:t("#pdc_product_config").length?JSON.parse(t("#pdc_product_config").val()):"",isServerNginx:t("#server-nginx").length?t("#server-nginx").val():0},n=t("#sides_config").length&&t("#sides_config").val()?JSON.parse(t("#sides_config").val()):"";fabric.util.object.extend(fabric.IText.prototype,{letterSpace:0,_renderChar:function(e,t,a,i,n,r,s,o){var c,l,d,h=this._fontSizeFraction*o/this.lineHeight;if(this.styles&&this.styles[a]&&(c=this.styles[a][i])){var u=c.stroke||this.stroke,g=c.fill||this.fill;t.save(),l=this._applyCharStylesGetWidth(t,n,a,i,c),d=this._getHeightOfChar(t,n,a,i);for(var f=n,p=(String.prototype.split.call(f,""),0),v=0,i=0;i<f.length;i++)m=(_=this.getCurrentCharStyle(a,i+1)).letterSpace,i>0&&(p+=parseInt(m)+parseInt(t.measureText(f.charAt(i-1)).width)),0!==this.text.indexOf(f)&&0===p&&(p=this.text.indexOf(f)*parseInt(m)),v=parseInt(r)+parseInt(p),g&&t.fillText(f.charAt(i),v,s),u&&t.strokeText(f.charAt(i),v,s);this._renderCharDecoration(t,c,r,s,h,l,d),t.restore(),t.translate(l,0)}else{l=this._applyCharStylesGetWidth(t,n,a,i);for(var m,f=n,p=(String.prototype.split.call(f,""),0),v=0,i=0;i<f.length;i++){var _=this.getCurrentCharStyle(a,i+1);m=_.letterSpace,i>0&&(p+=parseInt(m)+parseInt(t.measureText(f.charAt(i-1)).width)),0!==this.text.indexOf(f)&&0===p&&(p=this.text.indexOf(f)*parseInt(m)),v=parseInt(r)+parseInt(p),"strokeText"===e&&this.stroke&&t[e](f.charAt(i),v,s),"fillText"===e&&this.fill&&t[e](f.charAt(i),v,s)}this._renderCharDecoration(t,null,r,s,h,l,this.fontSize),t.translate(t.measureText(n).width,0)}},getCurrentCharStyle:function(e,t){var a=this.styles[e]&&this.styles[e][0===t?0:t-1];return{fontSize:a&&a.fontSize||this.fontSize,fill:a&&a.fill||this.fill,textBackgroundColor:a&&a.textBackgroundColor||this.textBackgroundColor,textDecoration:a&&a.textDecoration||this.textDecoration,fontFamily:a&&a.fontFamily||this.fontFamily,fontWeight:a&&a.fontWeight||this.fontWeight,fontStyle:a&&a.fontStyle||this.fontStyle,stroke:a&&a.stroke||this.stroke,strokeWidth:a&&a.strokeWidth||this.strokeWidth,letterSpace:a&&a.letterSpace||this.letterSpace}},_renderTextLine:function(e,t,a,i,n,r){this.isEmptyStyles()||(n+=this.fontSize*(this._fontSizeFraction+.05)),this.callSuper("_renderTextLine",e,t,a,i,n,r)},_getWidthOfChar:function(e,t,a,i){if("justify"===this.textAlign&&/\s/.test(t))return this._getWidthOfSpace(e,a);var n=this._getStyleDeclaration(a,i);this._applyFontStyles(n);var r=this._getCacheProp(t,n),s=this.getCurrentCharStyle(a,i).letterSpace;if(this._charWidthsCache[r]&&this.caching)return parseInt(this._charWidthsCache[r])+parseInt(s);if(e){e.save();var o=this._applyCharStylesGetWidth(e,t,a,i);return o=parseInt(o)+parseInt(s),e.restore(),o}}}),a.prototype={version:"1.0.1",sides:{},status:0,action:"",sideIndexBeforeSwitch:0,target:{},newestJsonFilename:"",showLog:function(e,t){i.show_log&&(t=t||"log",console[t](e))},vLinePatternBrush:null,hLinePatternBrush:null,squarePatternBrush:null,diamondPatternBrush:null,texturePatternBrush:null,firstLoadFlag:!0,sampleDesignJson:"",allCanvas:{},sideLength:0,getCurrentCanvas:function(){var e=this.getActiveSide();if(e&&e.id)return this.allCanvas[e.id]},setCurrentCanvas:function(e){var t=this;return e instanceof fabric.Canvas&&(t.canvas=e),this},doRequest:function(e,a,i){var n=this;t.ajax({type:"POST",url:e,data:a,beforeSend:function(){n.showLoadingBar(),void 0!==window.Pace&&Pace.restart()},error:function(){console.log("Something went wrong..."),alert("Something went wrong! This ajax request has failed.")},success:function(e){i(e)}})},saveJsonFile:function(e,a){var r=this;if(n){var s={options:e||"",side_config:n};t.ajax({type:"POST",url:i.save_json_url,data:JSON.stringify(s),contentType:"application/json",beforeSend:function(){r.showLoadingBar()},error:function(e){console.log(e),console.log("Something went wrong...")},success:function(e){a(e)}})}},postData:function(e,t,a){var i;if(window.XMLHttpRequest)i=new XMLHttpRequest;else{if(!window.ActiveXObject)throw new Error("Ajax is not supported by this browser");i=new ActiveXObject("Msxml2.XMLHTTP")}i.onreadystatechange=function(){4===i.readyState&&200==i.status&&i.status<300&&(console.log(i.responseText),a(i.responseText))},console.info("using XMLHttpRequest"),i.open("POST",e),i.send(t)},saveDesignToCustomerAccount:function(){var e=this;if(1==e.checkJSONReady.status){e.exportThumbnaiForMinicart();var a={action:"save_customer_design",product_id:e.getCurrentProductId(),design_title:"",design_note:""};e.saveJsonFile(a,function(t){var a=JSON.parse(t);if("error"==a.status)return"guest"==a.message?e.showLoginModal():(alert(a.message),e.showLog("Can not save design to customer account","warn")),!1;e.newestJsonFilename=a.filename,e.checkJSONReady.resetChecking(),e.saveAndContinue(),e.closeIframe(),e.hideLoadingBar()})}else e.saveDesignToJSON(null,t('[pdc-data="SAVE_CUSTOMER_DESIGN"]'))},saveDesignWithDetailsToCustomerAccount:function(){var e=this;if(1==e.checkJSONReady.status){var a={action:"save_customer_design",product_id:e.getCurrentProductId(),design_title:t("#design_title").val()||"",design_note:t("#design_note").val()||""};e.saveJsonFile(a,function(t){var a=JSON.parse(t);if("error"==a.status)return"guest"==a.message?e.showLoginModal():(alert(a.message),e.showLog("Can not save design to customer account","warn")),!1;e.newestJsonFilename=a.filename,e.checkJSONReady.resetChecking(),e.saveAndContinue(),e.closeIframe(),e.hideLoadingBar()})}else e.saveDesignToJSON(null,t('[pdc-data="SAVE_CUSTOMER_DESIGN_DETAILS"]'))},saveAndContinue:function(){var a=this,i=top.document;a.showLog("Save And Continue","info"),a.showLog("Add new json filename to extra_option hidden input. "+a.newestJsonFilename,"info"),t("input[name='extra_options']",i).val(a.newestJsonFilename);var r=a.getCurrentProductId();if(t('input[name="pdc_product_config_json_'+r+'"]',i).length&&t('input[name="pdc_product_config_json_'+r+'"]',i).val(a.newestJsonFilename),t("#extra_options_value",i).val(JSON.stringify(n)),e.LoadDesign){var s=[];t.each(n,function(){this.sideSvg&&s.push({side_name:this.label,image_result:this.sideSvg})}),t("#sample_images",i).val(JSON.stringify(s)),LoadDesign.showSampleImage(),LoadDesign.reloadPrice(),a.showLog("Done update thumbnail and reload Price","info")}},reset:function(){this.status=0,this.action=""},getActiveSideIndex:function(){return this.getActiveSide().index()},getDesignObjectPrice:function(e){if(!e)return!1;this.showLog("Calculate final price for current side","info");var t,a=0;return e.forEachObject(function(e){t=parseFloat(e.price||0),a+=t}),a},isEnableClipartPrice:function(){var e=!1;return t("#pdc_product_config").length&&"1"===JSON.parse(t("#pdc_product_config").val()).show_price&&(e=!0),e},getActiveSide:function(){if(t(".side-item.active").length){var e=t(".side-item.active").attr("id").replace("side-","");return n[e]}},getCurrentProductId:function(){return t("#current_product_id").val()},initSidesData:function(){this.getSampleJson()&&(this.showLog("Assign json to sides properties!","info"),this.sampleDesignJson=this.getSampleJson(),t.extend(n,this.sampleDesignJson))},resetToSampleDesign:function(){this.showLog("Reset design to sample design or empty design","info");var e=this,a=e.getCurrentCanvas();if(a.setOverlayImage(null,a.renderAll.bind(a)),this.getSampleJson()){var i=this.getActiveSide().id;if(this.getSampleJson()[i]&&this.getSampleJson()[i].json){this.getCurrentCanvas().clear();var n=JSON.stringify(this.getSampleJson()[i].json)||"";n&&(e.pdcZoom.resetZoom(),this.getCurrentCanvas().loadFromJSON(n,function(){e.getCurrentCanvas().renderAll()}))}}else this.getCurrentCanvas().clear(),this.initCanvas();t.fancybox.close()},getSampleJson:function(){var e=this,a=top.document,i=t("#pdp_design_action",a).val();switch(e.showLog("Get Sample JSON if exists!","info"),i){case"edit_cart_item":case"share_design":if(t("#extra_options_value",a).length&&""!==t("#extra_options_value",a).val())try{if(n=JSON.parse(t("#extra_options_value",a).val()))return n}catch(e){this.showLog(e,"error")}break;default:if(t("#extra_options_value").length&&""!==t("#extra_options_value").val())try{var n=JSON.parse(t("#extra_options_value").val());if(n)return n}catch(e){this.showLog(e,"error")}}},downloadPng:function(){var e=this,a=pdc.getCurrentCanvas();a.clone(function(n){n.scale=a.scale,n=e.pdcZoom.resetZoomBeforeSave(n),e.doRequest(i.base_url+"pdc/download/png/",{format:"png",multiplier:1,base_code_image:n.toDataURL(),options:{is_backend:t("#is_backend").length}},function(a){e.showLog("The png file response to download png event","info");var n=JSON.parse(a);if("success"===n.status){if("1"==i.isServerNginx){var r=n.thumbnail_path,s=r.split("/"),o=s.length;o-=1,r=s.slice(-1)[0];var c=t("#link-download-after").val();c+="/type/png/file-name/"+r,t("a#pdc-show-link-down-link").attr("href",c),t.fancybox({href:"#pdc-show-link-down",modal:!1})}else window.location=n.thumbnail_path;return e.hideLoadingBar(),!1}alert(n.message)})})},downloadPdfFromPng:function(){var e=this,a=pdc.getCurrentCanvas();a.clone(function(n){n.scale=a.scale,n=e.pdcZoom.resetZoomBeforeSave(n),e.doRequest(i.base_url+"pdc/download/Pdfpng",{png_string:n.toDataURL(),options:{is_backend:t("#is_backend").length}},function(a){e.showLog("The pdf file response to download png event","info");var n=JSON.parse(a);if("success"===n.status){if("1"==i.isServerNginx){var r=n.pdf_url,s=r.split("/"),o=s.length;o-=1,r=s.slice(-1)[0];var c=t("#link-download-after").val();c+="/type/pdf/file-name/"+r,t("a#pdc-show-link-down-link").attr("href",c),t.fancybox({href:"#pdc-show-link-down",modal:!1})}else window.location=n.pdf_url;return e.hideLoadingBar(),!1}alert(n.message)})})},exportThumbnailImageForShare:function(){var a,n=this;t.each(this.allCanvas,function(){return a=this,!1});a&&a.clone(function(r){if(r.scale=a.scale||1,r.width>400){var s=400/r.width;r.setZoom(s),r.setWidth(a.width*s),r.setHeight(a.height*s)}var o=r.toDataURL({format:"jpeg",quality:.7});n.doRequest(i.save_thumbnail_url,{base_code_image:o,format:"jpg"},function(a){var i=JSON.parse(a);if("success"==i.status)if(console.info("Save design to json status "+n.checkJSONReady.status),1==n.checkJSONReady.status){var r={action:"save_for_share",product_id:n.getCurrentProductId(),note:i.thumbnail_path};n.saveJsonFile(r,function(a){n.checkJSONReady.resetChecking();var r=JSON.parse(a);if("error"==r.status)return n.showLog("Can not share this design","warn"),!1;n.newestJsonFilename=r.filename;try{var s=i.thumbnail_path,o=top.document,c=t("#product_url").val()+"?share="+r.share_id,l=t("head title",o).text()||"Customize Product",d=t('meta[name="description"]',o).attr("content")||"Cool design. Please check it out my friend!";if(void 0!==e.addthis){t(".share-info img").attr("src",s).css({width:"169px"}),t(".share-info .title").attr("href",c).text(l),t(".share-info .link").attr("href",c).text(c),t(".share-info .des").text(d);for(var h=0;h<e.addthis.links.length;h++)e.addthis.links[h].share.url=c,e.addthis.links[h].share.title=l||"Design Your Own";return n.showShareModal(),void n.hideLoadingBar()}console.info("Add this not ready yet")}catch(e){console.info("Add this has problem"),console.error(e)}n.hideLoadingBar()})}else n.saveDesignToJSON(null,t('[pdc-data="SHARE_DESIGN"]'))})})},readyToShareDesign:function(){var a=this,i=t("#product_url").val();a.showLog("Prepare add this share link","info"),a.saveJsonFile(function(n){a.showLog("Save json before share action","info");var r=JSON.parse(n);if("success"==r.status){t(".share-thumbnails").html(""),t.each(a.sides,function(){var e="<li><img src='"+this.image_result+"' width='200px' alt='"+this.side_name+"' /></li>";t(".share-thumbnails").append(e)});try{var s=i+"?share="+r.id;if(void 0!==e.addthis){for(var o=0;o<e.addthis.links.length;o++)e.addthis.links[o].share.url=s,e.addthis.links[o].share.title="Design Your Own";return t("#sharingPopup").modal("show"),void a.hideLoadingBar()}}catch(e){}}else alert(r.message)})},setActiveSideColor:function(){var e=this.getActiveSide().attr("color_code")||"";this.showLog("Active color: "+e,"info"),""!==e&&t("#colorTab .pdc_design_color li").each(function(){if(t(this).attr("color")===e)return t(this).addClass("selected"),!1})},updateImagePathBeforeAdd:function(e){if("image"==e.type){var t=i.media_url,a=e.src;if(a.match("https://chart.googleapis.com"))return!1;""!==a&&void 0!==a&&(a.match(t)||(e.src=e.isrc=this.replaceImagePath(a)))}return e},replaceImagePath:function(e){var t=i.media_url;return""===e||void 0===e||e.match(t)?e:(this.showLog("Replace image path","info"),t+e.split("/pdp/images/")[1])},checkImagePathInJson:function(e){if(e){var t=this,a="object"==typeof e?e:JSON.parse(e),i=a.backgroundImage,n=a.overlayImage,r=a.objects;return void 0!==i&&"image"==i.type&&(i.src=this.replaceImagePath(i.src)),void 0!==n&&"image"==n.type&&(n.src=this.replaceImagePath(n.src)),r.forEach(function(e){"image"==e.type&&t.updateImagePathBeforeAdd(e)}),JSON.stringify(a)}},removeSampleData:function(){if(!confirm("Are you sure?"))return!1;var e=i.base_url+"pdp/index/removeSampleData/product-id/"+this.getCurrentProductId();this.doRequest(e,{},function(e){var t=JSON.parse(e);if("success"!==t.status)return alert(t.message),!1;window.location.reload()})},reRenderSideThumbnailByIndex:function(e){var a=parseInt(e)+1,n=t("#pdc_sides li.pdp_side_item_content:nth-child("+a+")"),r=this;if(!n.length)return!1;if(!r.sides[e])return!1;if(r.showLog("Rerender side"+e,"info"),void 0!==n){var s=r.sides[e],o={side_img:n.attr("side_img"),side_overlay:n.attr("overlay"),side_inlay:n.attr("inlay"),side_color_id:t(".pdc_design_color li.active").attr("pdc-color")||"",side_color:n.attr("side_color")||t(".pdc_design_color li.active").attr("color")||"",color_code:n.attr("side_color")||n.attr("color_code")},c=JSON.parse(s.json),l=i.media_url+o.side_img,d=i.media_url+o.side_overlay;c.backgroundImage.src=l,c.overlayImage.src=d,s.json=JSON.stringify(c),s=t.extend(s,o);var h=o.side_inlay.split(","),u={canvas_wdith:h[0],canvas_height:h[1]};return r.renderThumbnail(s.json,u,function(n){var o=JSON.parse(n);"success"===o.status&&(s.image_result=o.thumbnail_path,r.sides[e]=s,t("#pdc_sides li.pdp_side_item_content:nth-child("+a+")").removeClass(i.rerenderClass),r.reRenderAllThumbnail())}),this}},addReRenderClass:function(){var e,a=this;t.each(a.sides,function(n,r){n!=a.getActiveSideIndex()&&(e=parseInt(n)+1,console.info("Need rerender item "+e),t("#pdc_sides li.pdp_side_item_content:nth-child("+e+")").addClass(i.rerenderClass))})},reRenderAllThumbnail:function(){if(t(".pdp_side_item_content."+i.rerenderClass).length){var e=t("li.pdp_side_item_content.rerender:first").index();this.reRenderSideThumbnailByIndex(e),(void 0).showLoadingBar()}else(void 0).hideLoadingBar();return!1},getFontList:function(){var e=[],a=t("#pdc_font_list");if(a.length&&a.val())e=JSON.parse(a.val());return e},getFontFamilyInline:function(e){var t=this.getFontList();if(t[e])return'<defs><style type="text/css"><![CDATA[@font-face {font-family: '+e+';src: url("'+i.media_url.replace("images","fonts")+t[e]+'");}]]></style></defs>'},getSidesConfig:function(){return n},prepareCanvas:function(){if(n){var e,a="",r=[],s=[],o=0,c=this;t.each(n,function(a,n){c.sideLength++,t('[pdc-data="main-canvas"] #canvas_side_'+n.id).length||(t('[pdc-data="main-canvas"]').append('<canvas id="canvas_side_'+n.id+'"></canvas>'),c.allCanvas[n.id]=new fabric.Canvas("canvas_side_"+n.id),c.allCanvas[n.id].setWidth(n.canvaswidth),c.allCanvas[n.id].setHeight(n.canvasheight),c.allCanvas[n.id].allowTouchScrolling=!0),e="<li>",e+='<a id="side-'+n.id+'" pdc-action="SWITCH_SIDE" class="side-item">',"image"==n.background_type&&n.filename&&(e+='<img width="70px" src="'+i.media_url+(n.thumbnail||n.filename)+'"/>'),e+="<span>"+n.label+"</span>",e+="</a>",e+="</li>",r.push({id:n.id,pos:parseInt(n.position||0),html:e}),o++}),s=r.sort(function(e,t){return e.pos-t.pos}),t.each(s,function(){a+=this.html}),t('[pdc-data="side-list"]').html(a),t('[pdc-data="side-list"] li:first .side-item').addClass("active"),1==o&&t("#pdc_sides").hide()}},initCanvas:function(){var e=this.getActiveSide();if(e){var a=e;if(a){var n=this.getCurrentCanvas();if(this.stopDrawingPdc(),t('[pdc-data="main-canvas"]').css({width:n.getWidth(),height:n.getHeight(),margin:"auto"}),t("#product-image-wrap .canvas-container").hide(),t("#canvas_side_"+e.id).parent().show(),"image"==a.background_type&&(a.filename||a.background_path)){var r=a.background_path||i.media_url+a.filename;this.addBackgroundLayer(r)}"1"==a.use_mask&&a.overlay&&this.addOverlayLayer(i.media_url+a.overlay);var s="";n.getObjects().length&&n._objects[0].object_type&&"background_color"==n._objects[0].object_type&&(s=n._objects[0].fill),this.addBackgroundColorLayer(s,{object_type:"background_color"},n),t(".topbar-content .item-title .canvas-size").length||t(".topbar-content .item-title").append('<span class="canvas-size"></span>'),t(".topbar-content .item-title .canvas-size")&&t(".topbar-content .item-title .canvas-size").html(" - "+parseInt(a.canvaswidth)+"x"+parseInt(a.canvasheight)+"px")}}},addBackgroundLayer:function(e,t,a){var i=this,a=a||this.getCurrentCanvas(),t=t||{};a.forEachObject(function(e){e.object_type&&"background"==e.object_type&&a.remove(e)});var n=e.split(".");i.showLoadingBar(),"svg"==n.slice(-1)?fabric.loadSVGFromURL(e,function(t,n){var r=fabric.util.groupSVGElements(t,n);r.set({top:0,left:0,originX:"left",price:n.price||0,originY:"top",width:parseInt(a.getWidth()-0),height:parseInt(a.getHeight()-0),alignX:n.alignX||"min",alignY:n.alignY||"min",meetOrSlice:n.meetOrSlice||"slice",selectable:!1,object_type:"background",hasBorders:!1,evented:!1,isrc:e}),a.insertAt(r,1),a.renderAll(),n.skip_update_background_path||i.updateBackgroundInfoToSizeConfig(e,i.getActiveSide().id||""),i.hideLoadingBar()}):fabric.Image.fromURL(e,function(n){n.set({top:0,left:0,originX:"left",price:t.price||0,originY:"top",width:parseInt(a.getWidth()-0),height:parseInt(a.getHeight()-0),alignX:t.alignX||"min",alignY:t.alignY||"min",meetOrSlice:t.meetOrSlice||"slice",selectable:!1,object_type:"background",hasBorders:!1,evented:!1,isrc:e}),a.insertAt(n,1),a.renderAll(),t.skip_update_background_path||i.updateBackgroundInfoToSizeConfig(e,i.getActiveSide().id||""),i.hideLoadingBar()})},addBackgroundColorLayer:function(e,t,a){var a=a||this.getCurrentCanvas(),e=e||"#ffffff";t=t||{},a.forEachObject(function(e){e.object_type&&"background_color"==e.object_type&&a.remove(e)});var i=new fabric.Rect({width:parseInt(a.width),height:parseInt(a.height),top:0,left:0,fill:e,object_type:"background_color",selectable:!1,evented:!1});a.insertAt(i,0),a.renderAll()},updateBackgroundInfoToSizeConfig:function(e,a){if(e&&a){var i=t("#side-"+a),n=e.split("/").splice(-1),r=e.replace(n,"resize/resize_"+n),s=document.createElement("img");s.onload=function(){t("#side-"+a).find("img").attr("src",this.src)},s.onerror=function(){console.warn("No Thumbnail Found"),i.find("img").attr("src",e)},s.src=r,this.getSidesConfig()[a].background_path=e}},addOverlayLayer:function(e,t,a){var a=a||this.getCurrentCanvas(),t=t||{},i=this;i.showLoadingBar(),fabric.Image.fromURL(e,function(n){n.set({width:parseFloat(a.width),height:parseFloat(a.height),originX:"left",originY:"top",top:0,left:0,alignX:t.alignX||"none",alignY:t.alignY||"none",meetOrSlice:t.meetOrSlice||"meet",isrc:e,object_type:"mask",price:t.price||0}),a.setOverlayImage(n,a.renderAll.bind(a)),i.hideLoadingBar()}),a.renderAll(),a.controlsAboveOverlay=!0},addText:function(e,t){var a=this.getCurrentCanvas(),n=new fabric.IText(e,{fontFamily:"Arial",fontSize:t||i.productConfig.default_fontsize||25,textAlign:"left",fill:i.productConfig.default_color||"#000",price:i.productConfig.note.text_price,lineHeight:i.productConfig.default_fontheight||1.3,borderColor:"#808080",cornerColor:"rgba(68,180,170,0.7)",cornerSize:16,cornerRadius:12,transparentCorners:!1,centeredScaling:!0,rotatingPointOffset:40,padding:5});n.setControlVisible("mt",!1),a.centerObject(n),a.add(n).setActiveObject(n),a.calcOffset().renderAll(),this.scrollToCenterDesign()},addImage:function(e,t,a){if(t=t||{},e){var i=e.split("."),n=this.getCurrentCanvas(),r=this;"svg"!=i[i.length-1]?(this.showLoadingBar(),fabric.Image.fromURL(e,function(i){i.set({angle:0,price:t.price||0,id:t.id||Date.now(),scaleY:n.width/i.width/2/n.getZoom(),scaleX:n.width/i.width/2/n.getZoom(),isrc:e,object_type:t.object_type||"image",borderColor:"#808080",cornerColor:"rgba(68,180,170,0.7)",cornerSize:16,cornerRadius:12,transparentCorners:!1,centeredScaling:!0,rotatingPointOffset:40,padding:5}),i.setControlVisible("mt",!1),i.setCoords(),n.centerObject(i),n.add(i).setActiveObject(i),r.hideLoadingBar(),a&&a()})):this.addSvg(e,t,a)}this.scrollToCenterDesign()},addSvg:function(e,t,a){t=t||{};var n=this.getCurrentCanvas();fabric.loadSVGFromURL(e,function(r,s){var o=fabric.util.groupSVGElements(r,s),c=n.getZoom();o.set({fill:t.color||i.productConfig.default_color||null,perPixelTargetFind:!0,isrc:e,price:t.price||0,id:t.id||Date.now(),scaleY:n.width/o.width/2/c,scaleX:n.width/o.width/2/c,object_type:t.object_type||"",borderColor:"#808080",cornerColor:"rgba(68,180,170,0.7)",cornerSize:16,cornerRadius:12,transparentCorners:!1,centeredScaling:!0,rotatingPointOffset:40,padding:5}),o.setControlVisible("mt",!1),o.width>n.width&&o.scaleToWidth(n.width/2),n.centerObject(o),o.hasRotatingPoint=!0,n.add(o).setActiveObject(o),n.renderAll(),a&&a()})},addFrameToDesign:function(e,t){this.addOverlayLayer(e,t)},removeFrameFromDesign:function(){var e=this.getCurrentCanvas();e.setOverlayImage(null,e.renderAll.bind(e)),e.renderAll()},getBaseUrl:function(){return i.base_url},saveDesignToJSON:function(e,a){if(Array.isArray(e)||(e=["name","isrc","price","object_type","selectable","scale","evented","mk_letter"]),!a)return!1;if(n){var i,r,s=this,o=0,c=0;s.checkJSONReady.status=0,s.checkJSONReady.currentTarget=a,s.checkJSONReady.checking(),t.each(n,function(t,a){!function(t,a){a.clone(function(n){if(n.scale=a.scale,n=s.pdcZoom.resetZoomBeforeSave(n),s.hasDesignItem(n)){if(1==n.getObjects().length){var r=n.getObjects()[0]||!1;r.fill&&r.object_type&&"background_color"==r.object_type&&"#ffffff"==r.fill||(i=s.modifiedSvg(n,t.canvaswidth,t.canvasheight),t.sideSvg=i,t.json=n.toJSON(e))}else i=s.modifiedSvg(n,t.canvaswidth,t.canvasheight),t.sideSvg=i,t.json=n.toJSON(e);o=parseFloat(t.price)+s.getDesignObjectPrice(a),t.final_price=o.toFixed(2)}else t.sideSvg&&delete t.sideSvg,t.final_price=0;++c==s.sideLength&&(console.info("All side json updated, change status to 1"),s.checkJSONReady.status=1)},e)}(a,r=s.allCanvas[a.id])})}},modifiedSvg:function(e,a,i){var n=[],r=this,s=r.getFontList(),o="",c=e.toSVG({viewBox:{x:0,y:0,width:a,height:i}},function(e){return e.match("font-family")&&(t.each(s,function(a,i){-1==t.inArray(a,n)&&e.match('font-family="'+a+'"')&&(o=r.getFontFamilyInline(a),n.push(a))}),e=o+e),e});return c=c.replace('width="'+a+'"','width="100%"'),c=c.replace('height="'+i+'"','height="100%"'),c=c.replace(/xmidYmid/g,"xMidYMid"),c=c.replace(/xminYmin/g,"xMinYMin")},restoreDesignFromJson:function(){var e=this;n&&t.each(n,function(t,a){!function(t){var a=e.allCanvas[t.id];if(a&&!a.scale&&e.pdcZoom.autoZoom(a),t.json){var i=e.checkImagePathInJson(t.json);a.setOverlayImage(null,a.renderAll.bind(a)),e.showLoadingBar(),a.loadFromJSON(i,function(){e.pdcZoom.updateOverlaySize(a),a.renderAll(),e.hideLoadingBar()},function(i,n){if(n&&(n.set({borderColor:"#808080",cornerColor:"rgba(68,180,170,0.7)",cornerSize:16,cornerRadius:12,transparentCorners:!1,centeredScaling:!0,rotatingPointOffset:40,padding:5}),n.setControlVisible("mt",!1)),n.object_type&&"background"==n.object_type&&e.updateBackgroundInfoToSizeConfig(n.isrc||n.src,t.id),a.scale&&1!=a.scale){var r=n.scaleX,s=n.scaleY,o=n.left,c=n.top,l=a.scale,d=r*l,h=s*l,u=o*l,g=c*l;n.scaleX=d,n.scaleY=h,n.left=u,n.top=g,n.setCoords()}if(i&&"image"==i.type){var f=document.createElement("img");f.onerror=function(){console.info("Image not exists on server!"),console.warn("There is image that be used on sample design but not exists on the server! Please remove the sample design and create new sample design."),a.remove(n)},f.src=i.isrc||i.src}}),a.renderAll()}else{var n=t.dm_bgcolor||"#ffffff";a.clear(),e.addBackgroundColorLayer(n,{object_type:"background_color"},a)}}(a)})},closeIframe:function(){t.fancybox.close(),t("#pdc_iframe",top.document).css({top:"-100000px"}),t(".main-container",top.document).show(),t(".catalog-product-view",top.document).css({overflow:"inherit"})},showLoginModal:function(){t.fancybox({href:"#pdc-save-cont",modal:!1})},showShareModal:function(){t.fancybox({href:"#pdc-share-cont",modal:!1})},showLoadingBar:function(){t(".pdploading").show()},hideLoadingBar:function(){t(".pdploading").hide()},getProductConfig:function(){return i.productConfig},getProductImageCategoryIds:function(){var e=[],a=this.getProductConfig().selected_image;if(a){var i=JSON.parse(a);t.each(i,function(t,a){e.push(t)})}return e},hideObjectControl:function(){t("#pdc_toolbar_options").hide()},changeBackgroundColor:function(e){e&&(this.addBackgroundColorLayer(e),t("#background .items-list li a").css({"background-color":e}))},scrollToCenterDesign:function(){t(".scrollbar-map").length&&(t(".scrollbar-map").scrollTop(t(".scrollbar-map").height()/2),t(".scrollbar-map").scrollLeft(t(".scrollbar-map").width()/2))},pdcZoom:{SCALE_FACTOR:1.2,maxWidth:4e3,minWidth:300,maxHeightForAutoZoom:560,zoomIn:function(e,t){var a=this;if(e=e||pdc.getCurrentCanvas(),!a.validateBeforeZoomIn(e))return!1;e.scale=(e.scale||1)*a.SCALE_FACTOR,e.setHeight(e.getHeight()*a.SCALE_FACTOR),e.setWidth(e.getWidth()*a.SCALE_FACTOR);var i=e.getObjects();for(var n in i){var r=i[n].scaleX,s=i[n].scaleY,o=i[n].left,c=i[n].top,l=r*a.SCALE_FACTOR,d=s*a.SCALE_FACTOR,h=o*a.SCALE_FACTOR,u=c*a.SCALE_FACTOR;i[n].scaleX=l,i[n].scaleY=d,i[n].left=h,i[n].top=u,i[n].setCoords()}this.updateOverlaySize(e),e.renderAll(),this.updateWrappSize(e)},zoomOut:function(e,t){var a=this;if(e=e||pdc.getCurrentCanvas(),!a.validateBeforeZoomOut(e))return!1;e.scale=(e.scale||1)/a.SCALE_FACTOR,e.setHeight(e.getHeight()*(1/a.SCALE_FACTOR)),e.setWidth(e.getWidth()*(1/a.SCALE_FACTOR));var i=e.getObjects();for(var n in i){var r=i[n].scaleX,s=i[n].scaleY,o=i[n].left,c=i[n].top,l=r*(1/a.SCALE_FACTOR),d=s*(1/a.SCALE_FACTOR),h=o*(1/a.SCALE_FACTOR),u=c*(1/a.SCALE_FACTOR);i[n].scaleX=l,i[n].scaleY=d,i[n].left=h,i[n].top=u,i[n].setCoords()}this.updateOverlaySize(e),e.renderAll(),this.updateWrappSize(e)},resetZoom:function(e,t){var a=this;(e=e||pdc.getCurrentCanvas()).scale=e.scale||1,e.setHeight(e.getHeight()*(1/e.scale)),e.setWidth(e.getWidth()*(1/e.scale));var i=e.getObjects();for(var n in i){var r=i[n].scaleX,s=i[n].scaleY,o=i[n].left,c=i[n].top,l=r*(1/e.scale),d=s*(1/e.scale),h=o*(1/e.scale),u=c*(1/e.scale);i[n].scaleX=l,i[n].scaleY=d,i[n].left=h,i[n].top=u,i[n].setCoords()}a.updateOverlaySize(e),e.renderAll(),e.scale=1,this.updateWrappSize(e)},updateWrappSize:function(e){t('[pdc-data="main-canvas"]').css({width:e.getWidth(),height:e.getHeight()});var a=100*e.getWidth()/(e.getWidth()*(1/(e.scale||1)));t(".pdc-zoom .input-zoom").val(parseInt(a)+"%")},validateBeforeZoomIn:function(e){return!(parseFloat(e.getWidth())>this.maxWidth)||(alert("Canvas size is too big. You shouldn't zoom in any more!"),!1)},validateBeforeZoomOut:function(e){return!(parseFloat(e.getWidth())<this.minWidth)||(console.warn("Canvas size is too small. You shouldn't zoom out any more!"),!1)},updateOverlaySize:function(e){e&&e.overlayImage&&(e.overlayImage.width=e.getWidth(),e.overlayImage.height=e.getHeight())},resetZoomBeforeSave:function(e){if(e){e.scale=e.scale||1,e.setHeight(e.getHeight()*(1/e.scale)),e.setWidth(e.getWidth()*(1/e.scale));var t=e.getObjects();for(var a in t){var i=t[a].scaleX,n=t[a].scaleY,r=t[a].left,s=t[a].top,o=i*(1/e.scale),c=n*(1/e.scale),l=r*(1/e.scale),d=s*(1/e.scale);t[a].scaleX=o,t[a].scaleY=c,t[a].left=l,t[a].top=d,t[a].setCoords()}return this.updateOverlaySize(e),e.renderAll(),e}},autoZoom:function(e){if(e){if(e.height<=this.maxHeightForAutoZoom)return!1;for(var t=1,a=e.height;a>this.maxHeightForAutoZoom;)t*=1/this.SCALE_FACTOR,a*=1/this.SCALE_FACTOR;if(t>0&&a<=this.maxHeightForAutoZoom){if(!this.validateBeforeZoomOut(e))return!1;e.originalScale=t,this.zoomOutTo(e,t)}}},zoomOutTo:function(e,t){if(!e||!t)return!1;e.scale=t,e.setHeight(e.getHeight()*t),e.setWidth(e.getWidth()*t);var a=e.getObjects();for(var i in a){var n=a[i].scaleX*t,r=a[i].scaleY*t,s=a[i].left*t,o=a[i].top*t;a[i].scaleX=n,a[i].scaleY=r,a[i].left=s,a[i].top=o,a[i].setCoords()}this.updateOverlaySize(e),e.renderAll(),this.updateWrappSize(e)}},checkJSONReady:{status:0,currentTarget:"",timeOUt:"",checkingTime:0,checking:function(){var e=this;1!=e.status&&e.checkingTime<10?(e.checkingTime++,e.timeOut=setTimeout(pdc.checkJSONReady.checking.bind(e),300)):(1!=e.status?(console.warn("JSON not ready yet, but time already out. 10s now"),console.info("Finish auto call funciton")):(console.info("JSON ready, click this action again: "+e.currentTarget),e.currentTarget.click()),clearTimeout(e.timeOut))},resetChecking:function(){this.status=0,this.currentTarget="",this.checkingTime=0}},changeDesignTemplate:function(e,a){var i=JSON.parse(a),r=this;(n=i)&&t.each(n,function(e,t){var a=t.background_path||"";""!=a&&r.updateBackgroundInfoToSizeConfig(a,t.id)}),this.initCanvas(),this.restoreDesignFromJson()},hasDesignItem:function(e){var t=!1;return e.getObjects()&&e.getObjects().forEach(function(e){if(!e.object_type||"background_color"!=e.object_type&&"background"!=e.object_type)t=!0;else if("background"==e.object_type){var a=e.isrc||e.src;a&&a.match("images/artworks/")&&(t=!0)}}),t},exportThumbnaiForMinicart:function(){var e=this,a=top.document;if(n){var r=0;if(t.each(n,function(e,t){if(t.sideSvg)return r=parseInt(t.id),!1}),r>0){var s=e.allCanvas[r];s&&s.clone(function(n){if(n.width>200){var r=200/n.width;n.setZoom(r),n.setWidth(s.width*r),n.setHeight(s.height*r)}var o=n.toDataURL({format:"jpeg",quality:1});e.doRequest(i.save_thumbnail_url,{base_code_image:o,format:"jpg"},function(e){var i=JSON.parse(e);t("#temp-pdc-thumbnail",a).val(i.thumbnail_path)})})}}},updatePropertyDrawing:function(e,a){var i=this.getCurrentCanvas();if(i.freeDrawingBrush)if("draw_type"==e){var n=t("#drawing-color-value").val(),r=t("#drawing-line-width").val();i.freeDrawingBrush="hline"===a?this.vLinePatternBrush:"vline"===a?this.hLinePatternBrush:"square"===a?this.squarePatternBrush:"diamond"===a?this.diamondPatternBrush:"texture"===a?this.texturePatternBrush:new fabric[a+"Brush"](i),i.freeDrawingBrush.color=n,i.freeDrawingBrush.width=parseInt(r,10)||1}else"color"==e?i.freeDrawingBrush.color=a:"line_width"==e&&(i.freeDrawingBrush.width=parseInt(a,10)||1)},intallizeDrawingPdc:function(){t("#drawing-attribute-content").css("display","block");var e=this.getCurrentCanvas();if(e.isDrawingMode=!0,fabric.PatternBrush){this.vLinePatternBrush=new fabric.PatternBrush(e),this.vLinePatternBrush.getPatternSrc=function(){var e=fabric.document.createElement("canvas");e.width=e.height=10;var t=e.getContext("2d");return t.strokeStyle=this.color,t.lineWidth=5,t.beginPath(),t.moveTo(0,5),t.lineTo(10,5),t.closePath(),t.stroke(),e},this.hLinePatternBrush=new fabric.PatternBrush(e),this.hLinePatternBrush.getPatternSrc=function(){var e=fabric.document.createElement("canvas");e.width=e.height=10;var t=e.getContext("2d");return t.strokeStyle=this.color,t.lineWidth=5,t.beginPath(),t.moveTo(5,0),t.lineTo(5,10),t.closePath(),t.stroke(),e},this.squarePatternBrush=new fabric.PatternBrush(e),this.squarePatternBrush.getPatternSrc=function(){var e=fabric.document.createElement("canvas");e.width=e.height=12;var t=e.getContext("2d");return t.fillStyle=this.color,t.fillRect(0,0,10,10),e},this.diamondPatternBrush=new fabric.PatternBrush(e),this.diamondPatternBrush.getPatternSrc=function(){var e=fabric.document.createElement("canvas"),t=new fabric.Rect({width:10,height:10,angle:45,fill:this.color}),a=t.getBoundingRectWidth();e.width=e.height=a+5,t.set({left:a/2,top:a/2});var i=e.getContext("2d");return t.render(i),e};var a=new Image;a.src=i.media_url+"honey_im_subtle.png",this.texturePatternBrush=new fabric.PatternBrush(e),this.texturePatternBrush.source=a}if(e.freeDrawingBrush){var n=t("#drawing-color-value").val(),r=t("#drawing-line-width").val();e.freeDrawingBrush.color=n,e.freeDrawingBrush.width=parseInt(r,10)||1}},stopDrawingPdc:function(){var e=this.getCurrentCanvas();t("#drawing-attribute-content").css("display","none"),e.isDrawingMode=!1}},a.init=function(){var e=this;t(document).on("click",'[pdc-action="SWITCH_SIDE"]',function(){if(t(this).hasClass("active"))return!1;t('[pdc-action="SWITCH_SIDE"]').removeClass("active"),t(this).addClass("active"),t.each(e.allCanvas,function(e,t){t.deactivateAll(),t.renderAll()}),e.hideObjectControl(),e.initCanvas(),e.pdcZoom.updateWrappSize(e.getCurrentCanvas()),PDC_layer.load_layer()}),t('[pdc-data="add-text"]').click(function(){e.addText(t(this).text(),parseFloat(t(this).attr("fontsize"))),t(".pdc-style-family").prop("selectedIndex",0).css({"font-family":"Arial"})}),t('[pdc-action="SAVE_SAMPLE_DESIGN"]').click(function(){if(1==e.checkJSONReady.status){var a;if(t('[pdc-data="side-list"] li:first .side-item').length){var n=t('[pdc-data="side-list"] li:first .side-item').attr("id").replace("side-","");n&&(a=e.allCanvas[n])}a&&a.clone(function(n){if(n.width>200){var r=200/n.width;n.setZoom(r),n.setWidth(a.width*r),n.setHeight(a.height*r)}var s=n.toDataURL({format:"jpeg",quality:1});e.doRequest(i.save_thumbnail_url,{base_code_image:s,format:"jpg"},function(a){var i=JSON.parse(a);if("success"==i.status){var n={action:"save_sample",product_id:e.getCurrentProductId(),template_thumbnail:i.filename,template_id:t("#template_id").val()};e.saveJsonFile(n,function(a){e.checkJSONReady.resetChecking();var i=JSON.parse(a);if("error"==i.status)return e.showLog("Can not save this design","warn"),!1;e.newestJsonFilename=i.filename;try{var n=t("#base_url").val()+"pdc/designarea/index/productid/"+e.getCurrentProductId()+"/#/templatelist/product/"+e.getCurrentProductId();window.location=n}catch(e){console.error(e)}e.hideLoadingBar()})}else alert(i.message)})})}else e.saveDesignToJSON(null,t(this))}),t('[pdc-action="REMOVE_SAMPLE_DESIGN"]').click(function(){e.removeSampleData()}),t('[pdc-data="SAVE_GUEST_DESIGN"]').click(function(){if(1==e.checkJSONReady.status){var a={action:"save_guest_design",product_id:e.getCurrentProductId()};e.exportThumbnaiForMinicart(),e.saveJsonFile(a,function(t){var a=JSON.parse(t);if("error"==a.status)return e.showLog("Can not save guest design","warn"),!1;e.newestJsonFilename=a.filename,e.checkJSONReady.resetChecking(),e.saveAndContinue(),e.closeIframe(),e.hideLoadingBar()})}else e.saveDesignToJSON(null,t(this))}),t('[pdc-data="SAVE_CUSTOMER_DESIGN"]').click(function(){var a=!1;if(t.each(e.allCanvas,function(t,i){if(e.hasDesignItem(i))return a=!0,!0}),!a)return alert("There is no design item. Please add text or image to design!"),!1;if(t("#is_customer_logged").val()||0){if(t("#pdp-save-design-details").length)return t.fancybox({href:"#pdc-save-design-details",modal:!1}),!1;e.saveDesignToCustomerAccount()}else e.showLoginModal()}),t('[pdc-data="RESET_DESIGN"]').click(function(){e.resetToSampleDesign()}),t('[pdc-data="SAVE_DESIGN_BEFORE_CLOSE"]').click(function(){t('[pdc-data="SAVE_GUEST_DESIGN"]').click()}),t('[pdc-data="CLOSE_DESIGN_WITHOUT_SAVE"]').click(function(){e.closeIframe()}),t('[pdc-data="SHARE_DESIGN"]').click(function(){e.exportThumbnailImageForShare()}),t('[pdc-data="VIEW_TEMPLATE_LIBRARY"]').click(function(){var a=t("#base_url").val()+"pdc/designarea/index/productid/"+e.getCurrentProductId()+"/#templatelist/product/"+e.getCurrentProductId();window.location=a}),t('[pdc-data="DOWNLOAD-PNG"]').click(function(){e.downloadPng()}),t('[pdc-data="DOWNLOAD-PDF"]').click(function(){e.downloadPdfFromPng()}),t('[pdc-data="SAVE_CUSTOMER_DESIGN_DETAILS"]').click(function(){e.saveDesignWithDetailsToCustomerAccount()}),t("#start-drawing").click(function(){e.intallizeDrawingPdc()}),t("#stop-drawing").click(function(){e.stopDrawingPdc()}),t(".pdc-color-list-frawing a").click(function(){var a=t(this).attr("pdc-data-color");t("#drawing-color-value").val(a),e.updatePropertyDrawing("color",a)}),t("#drawing-line-width").change(function(){var a=t(this).val();t(this).prev().html(a),e.updatePropertyDrawing("line_width",a)}),t("#drawing-mode-selector").change(function(){var a=t(this).val();e.updatePropertyDrawing("draw_type",a)}),t("[pdc-background-images]").click(function(){var a=t(this).attr("pdc-background-images");t(".product-colors li").removeClass("active"),t(this).addClass("active"),a&&(a=JSON.parse(a),t.each(n,function(n,r){!function(n){if(!n.id||!a[n.id])return!0;n.filename=a[n.id].filename;var r=i.media_url+n.filename;n.background_path=r;var s=r;if(a[n.id].filename_thumbnail&&(s=i.media_url+a[n.id].filename_thumbnail),t("#side-"+n.id).find("img").attr("src",s),e.addBackgroundLayer(r,{object_type:"background",side_id:n.id,skip_update_background_path:!0},e.allCanvas[n.id]),"1"==n.use_mask){n.overlay=a[n.id].overlay;var o=i.media_url+n.overlay;e.addOverlayLayer(o,{},e.allCanvas[n.id])}e.allCanvas[n.id].renderAll()}(r)}))}),e.prepareCanvas(),e.initCanvas(),e.initSidesData(),e.restoreDesignFromJson()},a.init.prototype=a.prototype,e.PDC=a}(window,jQuery);